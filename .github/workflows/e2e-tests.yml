name: E2E Tests

on:
  push:
    branches:
      - master
  workflow_dispatch:

jobs:
  test:
    name: Run E2E Tests on Self-Hosted Ubuntu
    runs-on: self-hosted
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          clean: false  # Nie czyÅ›Ä‡ repo agresywnie (self-hosted)
          fetch-depth: 1  # Tylko ostatni commit

      - name: ğŸ³ Run Playwright tests in Docker (no compose)
        run: |
          docker run --rm \
            -v ${{ github.workspace }}:/app \
            -w /app \
            -e VERCEL_AUTOMATION_BYPASS_SECRET=${{ secrets.VERCEL_AUTOMATION_BYPASS_SECRET }} \
            -e PLAYWRIGHT_BASE_URL=https://easy-drive-test.vercel.app \
            -e CI=true \
            mcr.microsoft.com/playwright:v1.58.2-jammy \
            /bin/bash -c "npm ci && npm run test:e2e && chown -R $(id -u):$(id -g) /app/e2e"

      - name: ğŸ“‹ Verify reports
        if: always()
        run: |
          ls -la e2e/html-report/ || echo "No HTML report"
          ls -la e2e/test-results/ || echo "No test results"

      - name: ğŸ“¤ Upload HTML report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: e2e/html-report/
          retention-days: 30

      - name: ğŸ“¤ Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: e2e/test-results/
          retention-days: 30

      - name: âœ… Tests passed
        if: success()
        run: echo "ğŸ‰ All E2E tests passed!"

      - name: âŒ Tests failed
        if: failure()
        run: |
          echo "âŒ E2E tests failed. Check artifacts."
          exit 1